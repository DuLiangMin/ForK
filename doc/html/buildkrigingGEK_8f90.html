<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>ForK Library: buildkrigingGEK.f90 File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script src="../mathjax/MathJax.js">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.3 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div id="top">
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ForK Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="namespaces.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Types&#160;List</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>File&#160;Members</span></a></li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="summary">
<a href="#func-members">Functions/Subroutines</a>  </div>
  <div class="headertitle">
<h1>buildkrigingGEK.f90 File Reference</h1>  </div>
</div>
<div class="contents">

<p>Subroutine to Build Kriging Surface based on Function and Gradient Values.  
<a href="#_details">More...</a></p>

<p><a href="buildkrigingGEK_8f90_source.html">Go to the source code of this file.</a></p>
<table class="memberdecls">
<tr><td colspan="2"><h2><a name="func-members"></a>
Functions/Subroutines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">subroutine&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="buildkrigingGEK_8f90.html#a72dba8d2d6ac7ec8b42e28f0b4b6aad1">buildkrigingGEK</a> (ndim, ntot, X, Y, gtot, pts, dims, dY, stot, H, beta, V, hyper, hyperflag, optflagi, covarflagi)</td></tr>
<tr><td class="mdescLeft">&#160;</td><td class="mdescRight">This subroutine creates a gradient-enhanced Kriging model based on Function and Gradient values supplied at the Training points. The process of creating a gradient-enhanced Kriging model is identical to that of creating a function-only model (described in <a href="buildkriging_8f90.html">buildkriging</a>). The details of creating the Kriging model are not repeated here. To create a gradient-enhanced model, the definitions for the training data, covariance matrix, and collocation matrix must be extended to include the derivative values. Using these modified defintions, the procedure in <a href="buildkriging_8f90.html">buildkriging</a> can be used to create the Kriging model. First, the vector of training data is redefined as a block vector containing function and derivative observations, given as: </p>
<p class="formulaDsp">
\[ \underline{Y} = \left[\begin{array}{c} Y \\\ \delta Y \end{array} \right] \]
</p>
<p> where the vector \(Y\) contains the function observations at the training points and the vector \(\delta Y\) contains the derivative observations for the training points. Based on training data in this form, the covariance matrix must also be extended to include the correlation between derivative values. The block definition of this covariance matrix is given as: </p>
<p class="formulaDsp">
\[ \underline{K} = \left[ \begin{array}{cc} cov(Y,Y) &amp; cov(Y,\delta Y) \\ cov(\delta Y,Y) &amp; cov(\delta Y,\delta Y) \end{array} \right] \]
</p>
<p> where \(cov(Y,Y)\) is the covariance matrix between function values (same as the covariance matrix used in a function-only model), \(cov(\delta Y, Y) \) is a rectangular matrix whose elements represent the covariance between the function values and derivative values at the training points and \(cov(\delta Y, \delta Y) \) represents the covariance between derivative observations.  <a href="#a72dba8d2d6ac7ec8b42e28f0b4b6aad1"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<div class="textblock"><p>Subroutine to Build Kriging Surface based on Function and Gradient Values. </p>

<p>Definition in file <a class="el" href="buildkrigingGEK_8f90_source.html">buildkrigingGEK.f90</a>.</p>
</div><hr/><h2>Function Documentation</h2>
<a class="anchor" id="a72dba8d2d6ac7ec8b42e28f0b4b6aad1"></a><!-- doxytag: member="buildkrigingGEK.f90::buildkrigingGEK" ref="a72dba8d2d6ac7ec8b42e28f0b4b6aad1" args="(ndim, ntot, X, Y, gtot, pts, dims, dY, stot, H, beta, V, hyper, hyperflag, optflagi, covarflagi)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">subroutine buildkrigingGEK </td>
          <td>(</td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>ndim</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>ntot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(ndim,ntot),intent(in)&#160;</td>
          <td class="paramname"><em>X</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(ntot),intent(in)&#160;</td>
          <td class="paramname"><em>Y</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>gtot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,dimension(gtot),intent(in)&#160;</td>
          <td class="paramname"><em>pts</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,dimension(gtot),intent(in)&#160;</td>
          <td class="paramname"><em>dims</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(gtot),intent(in)&#160;</td>
          <td class="paramname"><em>dY</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>stot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(stot,ntot+gtot),intent(in)&#160;</td>
          <td class="paramname"><em>H</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(stot),intent(out)&#160;</td>
          <td class="paramname"><em>Beta</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(ntot+gtot),intent(out)&#160;</td>
          <td class="paramname"><em>V</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">real(8),dimension(ndim+3),intent(out)&#160;</td>
          <td class="paramname"><em>hyper</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>hyperflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>optflagi</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">integer,intent(in)&#160;</td>
          <td class="paramname"><em>covarflagi</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>This subroutine creates a gradient-enhanced Kriging model based on Function and Gradient values supplied at the Training points. The process of creating a gradient-enhanced Kriging model is identical to that of creating a function-only model (described in <a href="buildkriging_8f90.html">buildkriging</a>). The details of creating the Kriging model are not repeated here. To create a gradient-enhanced model, the definitions for the training data, covariance matrix, and collocation matrix must be extended to include the derivative values. Using these modified defintions, the procedure in <a href="buildkriging_8f90.html">buildkriging</a> can be used to create the Kriging model. First, the vector of training data is redefined as a block vector containing function and derivative observations, given as: </p>
<p class="formulaDsp">
\[ \underline{Y} = \left[\begin{array}{c} Y \\\ \delta Y \end{array} \right] \]
</p>
<p> where the vector \(Y\) contains the function observations at the training points and the vector \(\delta Y\) contains the derivative observations for the training points. Based on training data in this form, the covariance matrix must also be extended to include the correlation between derivative values. The block definition of this covariance matrix is given as: </p>
<p class="formulaDsp">
\[ \underline{K} = \left[ \begin{array}{cc} cov(Y,Y) &amp; cov(Y,\delta Y) \\ cov(\delta Y,Y) &amp; cov(\delta Y,\delta Y) \end{array} \right] \]
</p>
<p> where \(cov(Y,Y)\) is the covariance matrix between function values (same as the covariance matrix used in a function-only model), \(cov(\delta Y, Y) \) is a rectangular matrix whose elements represent the covariance between the function values and derivative values at the training points and \(cov(\delta Y, \delta Y) \) represents the covariance between derivative observations. </p>
<p>For a function value at point \( \vec{x}&#39; \) and a derivative value with respect to \(x_{k}\) evaluated at point \(\vec{x}\), the covariance is found by differentiation of the function describing the covariance between function values. The expression for this covariance between function and derivative values is given as: </p>
<p class="formulaDsp">
\[ cov(\frac{\partial y}{\partial x_{k}},y&#39;)=\frac{\partial}{\partial x_{k}} k(\vec{x},\vec{x}&#39;) \]
</p>
<p> For the covariance between a derivative value with respect to \(x_{k}\) evaluated at point \(\vec{x}\) and a derivative value with respect to \(x_{l}\) evaluated at point \(\vec{x}&#39;\), the covariance is found by differentiation of the above expression: </p>
<p class="formulaDsp">
\[ cov(\frac{\partial y}{\partial x_{k}},\frac{\partial y&#39;}{\partial x&#39;_{l}})=\frac{\partial^2}{\partial x_{k}\partial x&#39;_{l}} k(\vec{x},\vec{x}&#39;) \]
</p>
<p> Hence, to construct a gradient-enhanced Kriging model, the covariance function must be twice differentiable. This limits the choice of covariance function in this work to the Matern function with \(\nu \geq 3/2\). These covariance function and derivatives are computed using the functions in module <a href="covars_8f90.html">covars</a>. Finally, the collocation matrix must be extend to include the derivative of the basis functions. The block collocation matrix can be written as: </p>
<p class="formulaDsp">
\[ \underline{H} = \left[\begin{array}{c} H \\\ G \end{array} \right] \]
</p>
<p> where \(H\) represents the function collocation matrix and \(G\) represents the derivative collocation matrix. The elements of the function collocation matrix are defined as the basis functions for the regression evaluated at the training points. The elements of the derivative collocation matrix are defined as the derivatives of the basis functions for the regression evaluated at the training points. Using these definitions, the mean function values at the training points are defined as: </p>
<p class="formulaDsp">
\[ \bar{Y} = H \beta\]
</p>
<p> while the mean derivative values are given as: </p>
<p class="formulaDsp">
\[ \delta \bar{Y} = G \beta\]
</p>
<p> For a gradient-enhanced model, the size of the covariance matrix grows as the dimension of the space is increased (size=[(ndim+1)ntot x (ndim+1)ntot] if all components of the gradient are included at every point); hence, the expense of constructing the gradient-enhanced Kriging model grows quickly with dimension. LAPACK has been utilized extensively to help alleviate this cost in large dimension but it is still likely too slow to construct a gradient-enhanced model in more than \( \approx 20 \) dimensions. The derivative values themselves are inputted into the subroutine as a type of sparse matrix. Hence, three vectors are supplied to enter the derivative values (<em>pts</em>, <em>dims</em>, and <em>dY</em>). The elements of the vector <em>pts</em> give the index of the training point that the derivative value is evaluated at. The elements of the vector <em>dims</em> represent the component of the gradient that the derivative value represents and the vector <em>dY</em> contains the derivative values themselves. This data structure allows only certain components of the derivative to be enforced at different points. It also allows for only function values to be supplied at certain points. The final processed data produced by this subroutine is defined as: </p>
<p class="formulaDsp">
\[ \underline{V} = \underline{K}^{-1} \left( \underline{Y} - \underline{H}^{T} \beta) \]
</p>
 <dl class="author"><dt><b>Author:</b></dt><dd>Brian Lockwood Department of Mechanical Engineering University of Wyoming </dd></dl>
<dl class="date"><dt><b>Date:</b></dt><dd>May 1, 2012 </dd></dl>
<dl><dt><b>Parameters:</b></dt><dd>
  <table class="params">
    <tr><td class="paramname">in)</td><td><b>ndim </b>: The dimension of the problem </td></tr>
    <tr><td class="paramname">in)</td><td><b>ntot </b>: The number of training points (also function values) </td></tr>
    <tr><td class="paramname">in)</td><td><b>X </b>: The location of the training points (size=[ndimxntot]) </td></tr>
    <tr><td class="paramname">in)</td><td><b>Y </b>: Funcation values for the training points (size=[ntot]) </td></tr>
    <tr><td class="paramname">in)</td><td><b>gtot</b>: Number of derivative values included in training data (ndim*ntot if all derivatives are included at the training points) </td></tr>
    <tr><td class="paramname">in)</td><td><b>pts</b>: List identifying what point the derivative value is enforced at (size=[gtot] with values ranging from 1 to ntot) </td></tr>
    <tr><td class="paramname">in)</td><td><b>dims</b>: List identifying the dimension the derivative is taken with respect to (size=[gtot] with values ranging from 1 to ndim) </td></tr>
    <tr><td class="paramname">in)</td><td><b>dY</b>: Derivative values (size=[gtot]) </td></tr>
    <tr><td class="paramname">in)</td><td><b>stot </b>: Number of Terms in the regression </td></tr>
    <tr><td class="paramname">in)</td><td><b>H</b>: The collocation matrix for the regression including derivative values. (size=[stotxntot+gtot]) <br/>
 Columns 1:ntot are the basis evaluated at the training points <br/>
 Columns ntot+1:ntot+gtot are the derivative of the basis evaluated at the training points </td></tr>
    <tr><td class="paramname">out)</td><td><b> beta</b>: Regression coefficients based on the optimal estimate for the Kriging model (size=[stot]) </td></tr>
    <tr><td class="paramname">out)</td><td><b>hyper</b>: Hyperparameters for the Kriging Model (size=[ndim+3]) <br/>
 </p>
<ul>
<li>
hyper(1:ndim) correspond to the length scale used in each dimension ( \(\theta\) in the covariance functions) </li>
<li>
hyper(ndim+1) is the magnitude of the covariance matrix </li>
<li>
hyper(ndim+2) is the fitted noise for the function evaluations </li>
<li>
hyper(ndim+3) is the fitted noise for the gradient evaluations </li>
</ul>
</td></tr>
    <tr><td class="paramname">out)</td><td><b>V</b>: Processed Training Data (size=[ntot+gtot]) <br/>
 In order to make predictions from the Kriging Model, the inverse of the covariance matrix onto the residual of the training data from the regression is all that is needed. To avoid re-computing and inverting the covariance matrix, the product is stored explicitly </td></tr>
    <tr><td class="paramname">in)</td><td><b>hyperflagi</b>: Flag to govern how the hyperparameters are selected <br/>
 </p>
<ul>
<li>
hyperflag=0 uses the likelihood formula to determine the length scale only <br/>
 The noise in the Function is hard-coded as a small value simply to ensure the covariance matrix is properly conditioned <br/>
 The magnitude for the covariance function is determined explicitly based on optimality for the likelihood function (Solve for magnitude when derivative of likelihood is set to zero) </li>
<li>
hyperflag=1 uses the likelihood formula based on all hyperparameters with no parameters determined by explicit relation <br/>
 All hyperparameters included noise and magnitude are determined via the optimization. Required when the amount of noise in the function evaluations is to be fitted. However, the dimension of the optimization problem is now higher so this will be slower.</li>
</ul>
</td></tr>
    <tr><td class="paramname">in)</td><td><b>optflagi</b>: Flag to govern the optimization algorithm used to determine the hyperparameters <br/>
 </p>
<ul>
<li>
optflag=0 Simplex Search (Nelder-Mead Method) to determine the hyperparameters <br/>
 Local optimization technique using simplex elements to determine search direction and line search to determine step sizes <br/>
 Fastest method but inherently sequential and may stall on local optimum </li>
<li>
optflag=1 Pattern Search used to determine hyperparameters <br/>
 Global optimization method with fixed search directions (forward and backward in each direction) <br/>
 Each iteration requires \(2*ndim\) likelihood evaluations; however, these may be performed in parallel using openmp (Each thread performs own likelihood evaluation so OMP_STACK_SIZE must be set large enough) <br/>
 </li>
</ul>
</td></tr>
    <tr><td class="paramname">in)</td><td><b>covarflagi</b>: Flag to govern which covariance function is used <br/>
 </p>
<ul>
<li>
covarflag==1 Uses Matern function with \(\nu=3/2\) </li>
<li>
covarflag==2 Uses Matern function with \(\nu=5/2\) </li>
</ul>
<p><br/>
 The parameter \(\nu\) governs the smoothness and differentiability of the covariance function. <br/>
 When using gradient values, \(\nu=1/2\) is not differentiable enough so \(\nu \geq 3/2\) must be used<br/>
 Good rule of thumb is to use the least smooth ( \(\nu=3/2\)) unless there is a reason to assume more smoothness in the data <br/>
 For small numbers of training points, higher \(\nu\) can improve accuracy </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="buildkrigingGEK_8f90_source.html#l00095">95</a> of file <a class="el" href="buildkrigingGEK_8f90_source.html">buildkrigingGEK.f90</a>.</p>

<p>References <a class="el" href="covars_8f90_source.html#l00014">covars::covarflag</a>, <a class="el" href="choleskymod_8f90_source.html#l00135">choleskymod::invertsymmetric()</a>, <a class="el" href="choleskymod_8f90_source.html#l00272">choleskymod::matrixmulttrans()</a>, <a class="el" href="choleskymod_8f90_source.html#l00346">choleskymod::matvec()</a>, <a class="el" href="choleskymod_8f90_source.html#l00416">choleskymod::matvectrans()</a>, <a class="el" href="opt_8f90_source.html#l00015">opt::optflag</a>, <a class="el" href="choleskymod_8f90_source.html#l00309">choleskymod::symmatrixmulttrans()</a>, <a class="el" href="choleskymod_8f90_source.html#l00381">choleskymod::symmatvec()</a>, and <a class="el" href="choleskymod_8f90_source.html#l00167">choleskymod::symmetricsolve()</a>.</p>

<p>Referenced by <a class="el" href="krigingwrapperGEK_8f90_source.html#l00012">krigingwrapper()</a>.</p>

</div>
</div>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>
Copyright (C) 2012 Brian A. Lockwood <br>
Generated on Tue May 1 2012 17:15:55 for Kriging Library
by&#160;<a href="http://www.doxygen.org/index.html"><img class="footer"
							 src="doxygen.png"
							 alt="doxygen"/></a>
1.7.3
</small></address>
